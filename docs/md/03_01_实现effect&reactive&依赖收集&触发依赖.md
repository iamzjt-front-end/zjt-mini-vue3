# 03_01_å®ç° effect & reactive & ä¾èµ–æ”¶é›† & è§¦å‘ä¾èµ–

### ä¸€ã€reactivity happy path

é¦–å…ˆæˆ‘ä»¬çŸ¥é“`reactivity`çš„`happy path`ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰å°±æ˜¯: é€šè¿‡`reactive`å®šä¹‰å“åº”å¼å˜é‡ï¼Œç„¶åé€šè¿‡`effect`
å»æ”¶é›†å“åº”å¼å˜é‡çš„ä¾èµ–ï¼Œç„¶åå®ç°ä¾èµ–çš„è‡ªåŠ¨æ”¶é›†å’Œè‡ªåŠ¨è§¦å‘ã€‚

é‚£æˆ‘ä»¬å…ˆæ¥ç¼–å†™ç¬¬ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼Œé€šè¿‡å•æµ‹æ¥å¸¦å¤§å®¶çœ‹ä¸€çœ‹åŠŸèƒ½éœ€æ±‚ã€‚

é¦–å…ˆåˆ æ‰ä¹‹å‰çš„`index.spec.ts`ï¼Œå»ºç«‹`effect.spec.ts`ï¼Œå®ç°`reactivity`çš„`happy path`ã€‚

```ts
describe('effect', function () {
  it.skip('happy path', function () {
    // * é¦–å…ˆå®šä¹‰ä¸€ä¸ªå“åº”å¼å¯¹è±¡
    const user = reactive({
      age: 10
    })

    // * get -> æ”¶é›†ä¾èµ–
    let nextAge;
    effect(() => {
      nextAge = user.age + 1;
    })

    // * effecté»˜è®¤ä¼šæ‰§è¡Œä¸€æ¬¡
    expect(nextAge).toBe(11);

    // * set -> è§¦å‘ä¾èµ–
    user.age++;
    expect(nextAge).toBe(12);
  });
});
```

é‚£ä¹ˆ`reactivity`çš„`happy path`çš„å•æµ‹ä¹¦å†™å®Œæ¯•ï¼Œå› ä¸ºæ ¸å¿ƒé€»è¾‘çš„å•æµ‹éœ€è¦ä¾èµ–äº`reactive`å’Œ`effect`
ä¸¤ä¸ªapiï¼Œæ‰€ä»¥æ­¤å¤„ **it.skip**ï¼Œå…ˆè·³è¿‡è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬å…ˆæ¥å®ç°`reactive`ã€‚

---------------------------------------------------------------------------------------

### äºŒã€reactive happy path

é‚£åœ¨å®ç°`reactive`ä¹‹å‰ï¼Œä¾æ—§å…ˆæ¥å†™`reactive`æ ¸å¿ƒé€»è¾‘çš„å•æµ‹ã€‚

```ts
describe('reactive', function () {
  it('happy path', function () {
    const original = { foo: 1 };
    const observed = reactive(original);

    expect(observed).not.toBe(original);
    expect(observed.foo).toBe(original.foo);
  });
});
```

è¿™ä¸ªå•æµ‹éœ€è¦æˆ‘ä»¬å®ç°çš„åŠŸèƒ½ä¸»è¦æœ‰ä¸¤ç‚¹:

1. å“åº”å¼å¯¹è±¡`observed`å’ŒåŸå§‹å¯¹è±¡`original`ä¸å…¨ç­‰ï¼›
2. `observed`ä¹Ÿèƒ½å–åˆ°`foo`å±æ€§çš„å€¼ï¼Œå¹¶ä¸”ä¸`original`ä¸€è‡´ã€‚

é‚£å¸¦ç€è¿™äº›éœ€æ±‚ï¼Œæˆ‘ä»¬æ¥ç€å»ºç«‹`reactive.ts`ï¼Œå®ç°ä¸€ä¸‹`reactive`çš„è¿™ä¸ªæœ€æ ¸å¿ƒçš„é€»è¾‘ã€‚

```ts
export function reactive(raw) {
  return new Proxy(raw, {
    // æ­¤å¤„ä½¿ç”¨proxyæŠ¥é”™çš„è¯ï¼Œéœ€è¦è¿›tsconfig.jsonä¸­ï¼Œé…ç½®"lib": ["DOM", "ES6"]ã€‚
    get(target, key) {
      const res = Reflect.get(target, key);

      // todo ä¾èµ–æ”¶é›†
      return res;
    },

    set(target, key, value) {
      const res = Reflect.set(target, key, value);

      // todo è§¦å‘ä¾èµ–
      return res;
    }
  })
}
```

è‡³æ­¤ï¼Œ`reactive`çš„`happy path`å®ç°å®Œæ¯•ï¼Œè‡³äºå¦‚ä½•è¿›è¡Œ`ä¾èµ–æ”¶é›†`å’Œ`è§¦å‘ä¾èµ–`ï¼Œæˆ‘ä»¬æ”¾åˆ°åé¢å†å»æ…¢æ…¢è€ƒè™‘ã€‚

é‚£ç°åœ¨ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹å•æµ‹æœ‰æ²¡æœ‰é€šè¿‡ã€‚

```shell
yarn test reactive
```

<img src="https://iamzjt-1256754140.cos.ap-nanjing.myqcloud.com/images/202211050559517.png" width="666" alt="03_01_reactiveæ ¸å¿ƒé€»è¾‘å•æµ‹"/>

æµ‹è¯•é€šè¿‡ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»§ç»­å®Œå–„`reactive`çš„é€»è¾‘ä»£ç ã€‚

æ¥ç€ï¼Œå†å»`reactive.spec.ts`å’Œ`effect.spec.ts`ä¸­å¼•å…¥`reactive`ã€‚

```ts
import { reactive } from '../reactive';
```

**ps:** è‡³äºä¸Šè¿°ä»£ç ä¸­é‡‡ç”¨`Reflect.get`è€Œä¸æ˜¯`target[key]`è¿”å›å±æ€§å€¼ï¼Œå°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è¯¦ç»†åšå‡ºé˜è¿°ã€‚

---------------------------------------------------------------------------------------

### ä¸‰ã€effect happy path

é‚£åªè¦å†æŠŠ`effect`å®Œå–„ï¼Œé‚£`reactivity`çš„`happy path`çš„å•æµ‹å°±ä¸ä¼šæŠ¥é”™äº†ã€‚

é‚£ä¹ˆï¼Œç°åœ¨ï¼Œå’±å°±å»å®Œå–„`effect`ã€‚å»ºç«‹`effect.ts`æ–‡ä»¶ï¼Œå¹¶å®Œå–„åŸºç¡€é€»è¾‘ã€‚

```ts
class ReactiveEffect {
  private _fn: any;

  constructor(fn) {
    this._fn = fn;
  }

  run() {
    this._fn();
  }
}

export function effect(fn) {
  const _effect = new ReactiveEffect(fn);

  _effect.run();
}
```

å¯ä»¥æ³¨æ„åˆ°ï¼Œæ­¤å¤„æˆ‘ä»¬å°è£…äº†`ReactiveEffect`ç±»ã€‚æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦å¯¹ä¼ è¿›æ¥çš„ä¾èµ–è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œå¹¶ä¸”ä»¥åè¿˜ä¼šæ‰©å±•å‡ºæ›´å¤šçš„åŠŸèƒ½ï¼Œæ‰€ä»¥å°†å…¶å°è£…ä¹Ÿæ˜¯ä¸ºäº†æ—¥åæ›´å¥½åœ°ç»´æŠ¤ã€‚

> æ­¤å¤„å¤šè¯´ä¸¤å¥ï¼š
>
> å°è£…æ¦‚å¿µé€šå¸¸ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå°è£…æ•°æ®å’Œå°è£…å®ç°ï¼Œä¹Ÿå°±æ˜¯ï¼š
>
> 1. ç›¸å…³çš„æ•°æ®ï¼ˆç”¨äºå­˜å‚¨å±æ€§ï¼‰
> 2. åŸºäºè¿™äº›æ•°æ®æ‰€èƒ½åšçš„äº‹ï¼ˆæ‰€èƒ½è°ƒç”¨çš„æ–¹æ³•ï¼‰ï¼›
>
> å°è£…çš„ç›®çš„æ˜¯å°†ä¿¡æ¯éšè—ï¼Œå³å±æ€§ä¸æ–¹æ³•çš„å¯è§æ€§ã€‚
>
>
ä»ã€Šè®¾è®¡æ¨¡å¼ã€‹çš„è§’åº¦å‡ºå‘ï¼Œå°è£…åœ¨æ›´é‡è¦çš„å±‚é¢ä½“ç°ä¸ºå°è£…å˜åŒ–ã€‚é€šè¿‡å°è£…å˜åŒ–çš„æ–¹å¼ï¼ŒæŠŠç³»ç»Ÿä¸­ç¨³å®šä¸å˜çš„éƒ¨åˆ†å’Œå®¹æ˜“å˜åŒ–çš„éƒ¨åˆ†éš”ç¦»å¼€æ¥ï¼Œåœ¨ç³»ç»Ÿçš„æ¼”å˜è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æ›¿æ¢é‚£äº›å®¹æ˜“å˜åŒ–çš„éƒ¨åˆ†ï¼Œå¦‚æœè¿™äº›éƒ¨åˆ†æ˜¯å·²ç»å°è£…å¥½çš„ï¼Œæ›¿æ¢èµ·æ¥ä¹Ÿç›¸å¯¹å®¹æ˜“ã€‚è¿™å¯ä»¥æœ€å¤§ç¨‹åº¦åœ°ä¿è¯ç¨‹åºçš„ç¨³å®šæ€§å’Œå¯æ‰©å±•æ€§ã€‚

ç»§ç»­å›å½’æ­£é¢˜ã€‚ğŸ’¬

æ­¤æ—¶ï¼Œå»æ‰`effect` `happy path`ä¸­`it`çš„`skip`ï¼Œç„¶åæ³¨é‡Šæ‰`set -> è§¦å‘ä¾èµ–`åçš„ä¸¤è¡Œï¼Œå…ˆä¸çœ‹`update`çš„è¿‡ç¨‹ï¼Œè¿è¡Œä¸€ä¸‹æµ‹è¯•ã€‚

```shell
yarn test
```

<img src="https://iamzjt-1256754140.cos.ap-nanjing.myqcloud.com/images/202211050708340.png" width="666" alt="03_02_effectéƒ¨åˆ†é€»è¾‘å•æµ‹"/>

---------------------------------------------------------------------------------------

### å››ã€é‡ä¸­ä¹‹é‡ ä¾èµ–æ”¶é›†å’Œè§¦å‘ä¾èµ–

é‚£ç°åœ¨çš„éš¾ç‚¹å°±æ¥äº†ï¼Œå¦‚ä½•è®©`user.age++`çš„æ—¶å€™ï¼Œ`nextAge`ä¹Ÿè‡ªåŠ¨æ›´æ–°ã€‚  
è¿™å…¶å®å°±å·²ç»åˆ°äº†å“åº”å¼ç³»ç»Ÿçš„æ ¸å¿ƒé€»è¾‘äº†ï¼Œä¹Ÿå°±æ˜¯ **`ä¾èµ–æ”¶é›†`** å’Œ **`è§¦å‘ä¾èµ–`**ï¼Œä¹Ÿå°±æ˜¯`track`å’Œ`trigger`çš„å®ç°ã€‚

#### 1. ä¾èµ–æ”¶é›† track

å›åˆ°`reactive.ts`ï¼Œ`Proxy`çš„`get`æ–¹æ³•ä¸­å¢åŠ `track`ï¼Œå½“æŸä¸ªå±æ€§è¢«è¯»å–æ—¶ï¼Œè¿›è¡Œä¾èµ–çš„æ”¶é›†ã€‚

> æˆ‘ä»¬è¿™é‡Œæ‰€è¯´çš„ä¾èµ–ï¼Œä¹Ÿå«å‰¯ä½œç”¨å‡½æ•°ï¼Œå³äº§ç”Ÿå‰¯ä½œç”¨çš„å‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œeffectå‡½æ•°çš„æ‰§è¡Œï¼Œä¼šç›´æ¥æˆ–é—´æ¥å½±å“å…¶å®ƒå‡½æ•°çš„æ‰§è¡Œï¼Œè¿™æ—¶æˆ‘ä»¬è¯´effectå‡½æ•°äº§ç”Ÿäº†å‰¯ä½œç”¨ã€‚

```ts
const res = Reflect.get(target, key);

track(target, key);
return res;
```

ç”±äºä¾èµ–æ˜¯è¢«effectåŒ…è£¹çš„ï¼Œæ‰€ä»¥å°±åœ¨`effect.ts`ä¸­æ¥å†™`track`çš„é€»è¾‘ã€‚

```ts
export function track(target, key) {
  // * target -> key -> dep
}
```

ä»ä¸Šå¯ä»¥çœ‹å‡ºï¼Œä¾èµ–å¯¹åº”çš„ç»“æ„ğŸŒ²åº”è¯¥å¦‚ä¸‹ï¼š

<img src="https://iamzjt-1256754140.cos.ap-nanjing.myqcloud.com/images/202211051239948.png" width="388" alt="03_03_ä¾èµ–æ ‘å½¢å…³ç³»"/>

- targetï¼šè¢«æ“ä½œï¼ˆè¯»å–ï¼‰çš„ä»£ç†å¯¹è±¡ï¼ˆ **user** ï¼‰ï¼›
- keyï¼šè¢«æ“ä½œï¼ˆè¯»å–ï¼‰çš„å­—æ®µåï¼ˆ **age** ï¼‰ï¼›
- depï¼šç”¨effectå‡½æ•°æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°ï¼ˆ **() => { nextAge = user.age + 1; }** ï¼‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦æ”¶é›†çš„ä¾èµ–ã€‚

é‚£è¿™é‡Œåˆ†åˆ«ä½¿ç”¨`WeakMap`ã€`Map`ã€`Set`æ¥å­˜å‚¨ã€‚

- `WeakMap`ç”± **target -> Map** æ„æˆï¼›
- `Map`ç”± **key -> Set** æ„æˆã€‚

å…¶ä¸­`WeakMap`çš„é”®æ˜¯åŸå§‹å¯¹è±¡`target`ï¼Œå€¼æ˜¯ä¸€ä¸ª`Map`å®ä¾‹ï¼›  
è€Œ`Map`çš„é”®æ˜¯åŸå§‹å¯¹è±¡`target`çš„`key`ï¼Œå€¼æ˜¯ä¸€ä¸ªç”±å‰¯ä½œç”¨å‡½æ•°ç»„æˆçš„`Set`ã€‚

<img src="https://iamzjt-1256754140.cos.ap-nanjing.myqcloud.com/images/202211051251337.png" width="666" alt="03_04_WeakMapã€Mapå’ŒSetä¹‹é—´çš„å…³ç³»"/>

ææ¸…æ¥šä»–ä»¬çš„å…³ç³»ä¹‹åï¼Œæœ‰å¿…è¦è§£é‡Šä¸€ä¸‹è¿™é‡Œä¸ºä»€ä¹ˆç”¨`WeakMap`ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†`WeakMap`å’Œ`Map`çš„åŒºåˆ«ã€‚

> ç®€å•åœ°è¯´ï¼Œ`WeakMap`å¯¹`key`æ˜¯å¼±å¼•ç”¨ï¼Œä¸å½±å“åƒåœ¾å›æ”¶å™¨çš„å·¥ä½œã€‚ä½†å¦‚æœä½¿ç”¨`Map`æ¥ä»£æ›¿`WeakMap`ï¼Œé‚£ä¹ˆå³ä½¿ç”¨æˆ·ä¾§çš„ä»£ç å¯¹`target`
> æ²¡æœ‰ä»»ä½•å¼•ç”¨ï¼Œè¿™ä¸ª`target`ä¹Ÿä¸ä¼šè¢«å›æ”¶ï¼Œæœ€ç»ˆå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚

ç†è®ºå®Œæ¯•ï¼Œæ¥ä¸‹æ¥å¼€å§‹å®Œå–„`track`çš„é€»è¾‘ã€‚

```ts
// * target -> key -> dep
export function track(target, key) {
  // * depsMap: key -> dep
  let depsMap = targetMap.get(target);
  if (!depsMap) {
    targetMap.set(target, (depsMap = new Map()));
  }

  // * dep
  let dep = depsMap.get(key);
  if (!dep) {
    depsMap.set(key, (dep = new Set()));
  }

  dep.add(activeEffect); // activeEffectæ˜¯å½“å‰ä¾èµ–ï¼Œå®Œæ•´ä»£ç æœ€åæŒ‚å‡º
}
```

#### 2. è§¦å‘ä¾èµ– trigger

å†æ¬¡å›åˆ°`reactive.ts`ï¼Œ`Proxy`çš„`set`æ–¹æ³•ä¸­å¢åŠ `trigger`ï¼Œå½“æŸä¸ªå±æ€§è¢«è¯»å–æ—¶ï¼Œè¿›è¡Œä¾èµ–çš„æ”¶é›†ã€‚

```ts
const res = Reflect.get(target, key);

track(target, key);
return res;
```

å†æ¥ç€å®Œå–„`trigger`çš„é€»è¾‘ï¼Œå–å‡ºæ‰€æœ‰çš„ä¾èµ–ï¼Œä¾æ¬¡æ‰§è¡Œã€‚

```ts
export function trigger(target, key) {
  let depsMap = targetMap.get(target);
  let dep = depsMap.get(key);

  for (const effect of dep) {
    effect.run();
  }
}
```

æ„Ÿè§‰å¥½åƒå°±è¿™æ ·ï¼Œæ²¡å•¥é—®é¢˜äº†ï¼Œé‚£ç»§ç»­è·‘ä¸€ä¸‹å•æµ‹å§ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯çœŸçš„æ²¡é—®é¢˜äº†ã€‚

<img src="https://iamzjt-1256754140.cos.ap-nanjing.myqcloud.com/images/202211051504999.png" width="666" alt="03_05_effectã€reactiveå…¨æµç¨‹å•æµ‹"/>

å¯ä»¥ï¼Œå…¨éƒ¨é€šè¿‡ï¼Œç¾æ»‹æ»‹å•Š~ ğŸ‰

é‚£ä¹ˆè‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®ç°äº† **`effect`** & **`reactive`** & **`ä¾èµ–æ”¶é›†`** & **`è§¦å‘ä¾èµ–`** çš„`happy path`ã€‚

**`ps:`** å½“ç„¶è¿™åªæ˜¯æœ€ç®€å½¢æ€çš„`reactive`ï¼Œå°±æ¯”å¦‚: åˆ†æ”¯åˆ‡æ¢ï¼ˆä¸‰å…ƒè¡¨è¾¾å¼ï¼‰ã€åµŒå¥—effectã€++çš„æƒ…å†µï¼Œæˆ‘ä»¬éƒ½å®Œå…¨è¿˜æ²¡æœ‰è€ƒè™‘è¿›å»ï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†æ¥å®Œå–„å¯¹è¿™äº›æƒ…å†µçš„å¤„ç†ã€‚